<script>
  document.getElementById('year').textContent = new Date().getFullYear();

  // ====== Configure your repo here ======
  const GITHUB_USER  = 'simke222';
  const GITHUB_REPO  = 'politinis_kampas';
  const GITHUB_BRANCH = 'main';
  // ======================================

  const postsApi = `https://api.github.com/repos/${GITHUB_USER}/${GITHUB_REPO}/contents/posts?ref=${GITHUB_BRANCH}`;
  const latestContainer = document.getElementById('latest-posts');

  function slugToTitle(name) {
    const cleaned = name.replace(/^\d{4}-\d{2}-\d{2}-/, '').replace(/\.(md|txt|html)$/, '');
    return cleaned.split('-').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
  }

  function dateFromSlug(name) {
    const m = name.match(/^(\d{4})-(\d{2})-(\d{2})/);
    if (!m) return null;
    return new Date(+m[1], +m[2] - 1, +m[3]);
  }

  function formatDate(d) {
    try {
      return d.toLocaleDateString('lt-LT', { year: 'numeric', month: 'long', day: 'numeric' });
    } catch {
      return '';
    }
  }

  async function loadLatest() {
    try {
      const res = await fetch(postsApi);
      if (!res.ok) throw new Error('GitHub API error');
      const files = await res.json();

      const posts = files
        .filter(f => f.name.toLowerCase().endsWith('.md') || f.name.toLowerCase().endsWith('.txt'))
        .sort((a, b) => {
          const da = dateFromSlug(a.name) || new Date(0);
          const db = dateFromSlug(b.name) || new Date(0);
          return db - da;
        })
        .slice(0, 2); // Show only 2 latest posts

      if (posts.length === 0) {
        latestContainer.innerHTML = '<p class="muted">No posts found yet.</p>';
        return;
      }

      const cards = await Promise.all(posts.map(async p => {
        const title = slugToTitle(p.name);
        const date = dateFromSlug(p.name);
        const dateStr = date ? formatDate(date) : '';
        let preview = '';

        try {
          const raw = await fetch(p.download_url).then(r => r.text());
          // Show more lines (first 6 instead of 3)
          preview = raw.split(/\r?\n/).slice(0, 6).join(' ')
            .replace(/[#*_`>\[\]]+/g, '')
            .trim();
        } catch {
          preview = '(Unable to load preview)';
        }

        const link = `post.html?file=${encodeURIComponent(p.name)}`;
        return `
          <article class="card post">
            <a class="card-link" href="${link}">
              <div class="card-body">
                <h2 class="card-title">${title}</h2>
                <p class="card-meta">${dateStr}</p>
                <p class="card-text">${preview}</p>
              </div>
            </a>
          </article>
        `;
      }));

      latestContainer.innerHTML = cards.join('');
    } catch (err) {
      latestContainer.innerHTML = `<p class="muted">Error loading posts: ${err.message}</p>`;
      console.error(err);
    }
  }

  document.addEventListener('DOMContentLoaded', loadLatest);
</script>
