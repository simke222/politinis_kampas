<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Post — politinis_kampas</title>
  <meta name="description" content="politinis_kampas — blog on world conflicts, analysis, and news." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css" />
  <link rel="icon" href="./favicon.ico" />

  <style>
    body {
      background-color: #000;
      color: #eee;
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 800px;
      margin: 2rem auto;
      padding: 1rem;
    }
    .site-header, .site-footer {
      background-color: #000;
      color: #ffcc00;
      padding: 1rem 0;
      text-align: center;
    }
    .site-header a, .site-footer a {
      color: #ffcc00;
      text-decoration: none;
      margin: 0 0.5rem;
    }
    h1, h2, h3, h4 {
      color: #ffcc00;
    }
    p {
      line-height: 1.6;
    }
    .post-body img {
      max-width: 100%;
      border-radius: 8px;
      margin: 1rem 0;
    }
    .card-meta {
      color: #aaa;
      margin-bottom: 1rem;
    }
  </style>
</head>

<body>
  <header class="site-header">
    <a class="brand" href="index.html">politinis_kampas</a> |
    <a href="blog.html">Blog</a> |
    <a href="feed.html">RSS Feed</a> |
    <a href="about.html">About</a> |
    <a href="contact.html">Contact</a>
  </header>

  <main class="container">
    <article id="article">
      <h1 id="post-title">Loading…</h1>
      <p id="post-meta" class="card-meta"></p>
      <div id="post-content" class="post-body">Fetching content…</div>
    </article>
  </main>

  <footer class="site-footer">
    <div>
      © <span id="year"></span> politinis_kampas |
      <a href="feed.html">RSS Feed Page</a>
    </div>
  </footer>

  <!-- Load Marked library (Markdown parser) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <!-- Main JS logic for post rendering -->
  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // ====== Your GitHub repo details ======
    const GITHUB_USER   = 'simke222';
    const GITHUB_REPO   = 'politinis_kampas';
    const GITHUB_BRANCH = 'main';
    // =====================================

    const params = new URLSearchParams(location.search);
    const filename = params.get('file'); // e.g., 2025-10-06-example.md

    function slugToTitle(slug) {
      return slug
        .replace(/^\d{4}-\d{2}-\d{2}-/, '')
        .replace(/\.(md|txt)$/,'')
        .split('-')
        .map(w => w.charAt(0).toUpperCase() + w.slice(1))
        .join(' ');
    }

    function dateFromSlug(slug) {
      const m = slug.match(/^(\d{4})-(\d{2})-(\d{2})/);
      if (!m) return '';
      const d = new Date(+m[1], +m[2]-1, +m[3]);
      return d.toLocaleDateString('lt-LT', { year: 'numeric', month: 'long', day: 'numeric' });
    }

    // Normalize weird characters so markdown headings like ## work
    function normalizeMd(text) {
      return text
        .replace(/^\uFEFF/, '')        // remove BOM
        .replace(/\r\n/g, '\n')        // fix Windows line breaks
        .replace(/\u00A0/g, ' ')       // replace non-breaking spaces
        .replace(/^[ \t]{0,3}(#{1,6})\s+/gm, (_, h) => `${h} `)
        .trim();
    }

    async function loadPost() {
      const content = document.getElementById('post-content');

      if (!filename) {
        document.getElementById('post-title').textContent = 'Post not found';
        content.textContent = 'Missing ?file= parameter.';
        return;
      }

      const rawUrl = `https://raw.githubusercontent.com/${GITHUB_USER}/${GITHUB_REPO}/${GITHUB_BRANCH}/posts/${encodeURIComponent(filename)}`;

      try {
        const res = await fetch(rawUrl);
        if (!res.ok) throw new Error('Fetch failed');
        const raw = await res.text();

        const title = slugToTitle(filename);
        const date  = dateFromSlug(filename);
        document.getElementById('post-title').textContent = title;
        document.title = `${title} — politinis_kampas`;
        document.getElementById('post-meta').textContent = date || '';

        const md = normalizeMd(raw);
        marked.setOptions({
          gfm: true,
          breaks: false,
          headerIds: true,
          mangle: false,
          smartypants: true
        });

        let html = marked.parse(md);

        // fallback if headings failed (rare edge case)
        if (/^##\s/m.test(md) && !/<h2>/i.test(html)) {
          html = md.replace(/^(#{1,6})\s+(.+)$/gm, (m, hashes, text) =>
            `<h${hashes.length}>${text}</h${hashes.length}>`)
            .replace(/\n{2,}/g, '</p><p>')
            .replace(/^([^<].*?)$/gm, '<p>$1</p>');
        }

        content.innerHTML = html;

        // style headings yellow dynamically
        document.querySelectorAll('h1,h2,h3,h4').forEach(h => {
          h.style.color  = '#ffcc00';
          h.style.margin = '1.2rem 0 0.6rem';
        });

      } catch (e) {
        document.getElementById('post-title').textContent = 'Error loading post';
        content.textContent = 'Could not fetch or render the file.';
        console.error(e);
      }
    }

    document.addEventListener('DOMContentLoaded', loadPost);
  </script>
</body>
</html>
